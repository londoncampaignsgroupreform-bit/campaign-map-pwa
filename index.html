<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Campaign Map</title>

    <style>
      html, body, #map {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #map {
        height: 100vh;
        width: 100%;
      }

      #wardSelector {
        position: absolute;
        top: 120px;
        left: 10px;
        z-index: 9999;
        background: rgba(255, 255, 255, 0.9);
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 13px;
        font-family: Arial, sans-serif;
      }

      #legend {
        position: absolute;
        bottom: 20px;
        left: 10px;
        z-index: 9999;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 13px;
        font-family: Arial, sans-serif;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        line-height: 1.6;
      }

      #userInfo {
        position: absolute;
        top: 60px;
        left: 10px;
        z-index: 9999;
        background: rgba(255, 255, 255, 0.9);
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 13px;
        font-family: Arial, sans-serif;
      }

      .popup-card {
        font-family: "Segoe UI", Roboto, Arial, sans-serif;
        font-size: 14px;
        line-height: 1.5;
        max-width: 260px;
        padding: 4px;
      }

      .popup-card strong {
        display: block;
        font-size: 15px;
        margin-bottom: 8px;
        color: #333;
      }

      .popup-card label {
        display: block;
        margin: 6px 0 4px;
        font-weight: 600;
        font-size: 13px;
        color: #444;
      }

      .popup-card select,
      .popup-card textarea {
        width: 100%;
        font-size: 13px;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 6px;
        box-sizing: border-box;
      }

      .popup-card select {
        height: 34px;
      }

      .popup-card textarea {
        resize: vertical;
        min-height: 60px;
        max-height: 120px;
      }

      .popup-card button {
        display: inline-block;
        margin-top: 10px;
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
      }

      .popup-card button:hover {
        background: #0056b3;
      }

      #saveModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      }

      #saveModal .modal-content {
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        max-width: 320px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        animation: fadeInUp 0.3s ease-out;
      }

      #saveModal img {
        width: 80px;
        margin-bottom: 12px;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      #mobileToolbar {
        position: fixed;
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 420px;
        display: flex;
        justify-content: space-between;
        background: #0078d4;
        padding: 10px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        z-index: 10000;
      }

      #mobileToolbar button {
        flex: 1;
        margin: 0 6px;
        padding: 12px;
        font-size: 15px;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        background: #fff;
        color: #0078d4;
        cursor: pointer;
      }

      #mobileToolbar button:hover {
        background: #e6f0fa;
      }

      #statusMessage {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: #fff;
        padding: 6px 12px;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 9999;
      }
    </style>

    <!-- MarkerClusterer -->
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

    <!-- ‚úÖ MAIN JAVASCRIPT -->
    <script>
const API = "https://script.google.com/macros/s/AKfycbwmT_Xf9yP-5_VtUZ04c7eeQgjDgl-X4T51EJeCe0EM48dafZ16_WhE2ShGD5rEZ2wN/exec";

function escapeHTML(str) {
  if (typeof str !== 'string') return String(str || '');
  return str.replace(/[&<>'"]/g, c => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    "'": "&#39;",
    '"': "&quot;"
  }[c]));
}

let token = null;
let userInfo = null;
let map = null;

const wardCenters = {
  "Bedfont": { lat: 51.4485, lng: -0.4325 },
  "Feltham North": { lat: 51.4560, lng: -0.4080 },
  "Feltham West": { lat: 51.4470, lng: -0.4170 },
  "Hanworth Park": { lat: 51.4375, lng: -0.3860 },
  "Hanworth Village": { lat: 51.4290, lng: -0.3790 }
};

const defaultCenter = { lat: 51.4405, lng: -0.4085 };

async function init() {
  const params = new URLSearchParams(window.location.search);
  token = params.get("token");

  if (!token) {
    window.location.href = "login.html";
    return;
  }

  const validateRes = await fetch(`${API}?action=validate&token=${token}`);
  const validateData = await validateRes.json();

  if (!validateData.success) {
    window.location.href = "login.html";
    return;
  }

  userInfo = validateData;

  document.getElementById("userInfo").innerHTML = `
    Logged in as <strong>${userInfo.user}</strong><br>
    Role: <strong>${userInfo.role}</strong><br>
    Access: ${userInfo.sheets.join(", ")}
  `;

  const sheetFilter = document.getElementById("sheetFilter");
  userInfo.sheets.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    sheetFilter.appendChild(opt);
  });

  initMap();
}

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: defaultCenter,
    zoom: 14.5,
    mapId: "af62d6188c33c416abdb1c28",
    gestureHandling: "greedy",
    scrollwheel: true,
    zoomControl: true,
    streetViewControl: true,
    mapTypeControl: true
  });

  fetchAndRenderMarkers();
}

async function fetchAndRenderMarkers() {
  const res = await fetch(`${API}?action=map-data&token=${token}`);
  const data = await res.json();
  renderMarkers(data);
}

function showStatus(msg) {
  const el = document.getElementById("statusMessage");
  el.textContent = msg;
  el.style.display = "block";
  setTimeout(() => el.style.display = "none", 3000);
}

function renderMarkers(data) {
  const selectedSheet = document.getElementById("sheetFilter").value;
  if (!selectedSheet) {
    showStatus("Please select a ward.");
    return;
  }

  if (window._markersArray && window._markersArray.length) {
    window._markersArray.forEach(m => m.setMap(null));
  }
  window._markersArray = [];

  const grouped = {};
  const bounds = new google.maps.LatLngBounds();

  data.forEach((row) => {
    let [lat, lng, address, status, notes, sheetName] = row;
    const latNum = parseFloat(lat), lngNum = parseFloat(lng);
    if (isNaN(latNum) || isNaN(lngNum)) return;
    if (selectedSheet !== "All" && sheetName !== selectedSheet) return;

    const key = `${latNum.toFixed(4)},${lngNum.toFixed(4)}`;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push({ lat: latNum, lng: lngNum, address, status, notes, sheetName });
  });

  if (Object.keys(grouped).length === 0) {
    showStatus("No markers found.");
    return;
  }

  const intentionColors = {
    "Labour": "#e4003b",
    "Tory": "#0087dc",
    "Lib Dem": "#faa61a",
    "Green": "#6ab023",
    "Reform": "#00b3b3",
    "Undecided": "#cccccc",
    "Considering": "#999999",
    "Against": "#000000",
    "Knocked": "#9966cc"
  };

  Object.values(grouped).forEach((group) => {
    const count = group.length;
    const angleStep = (2 * Math.PI) / count;
    const radius = 0.0001;

    group.forEach((item, i) => {
      const angle = i * angleStep;
      const offsetLat = item.lat + radius * Math.cos(angle);
      const offsetLng = item.lng + radius * Math.sin(angle);
      const color = intentionColors[item.status] || "#cccccc";

      const marker = new google.maps.Marker({
        position: { lat: offsetLat, lng: offsetLng },
        title: `${item.status}: ${item.address}`,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          fillColor: color,
          fillOpacity: 1,
          strokeColor: "white",
          strokeWeight: 1,
          scale: 6
        }
      });

      marker.status = item.status;

      window._markersArray.push(marker);
      bounds.extend(marker.getPosition());

      const markerId = `marker-${item.lat}-${item.lng}-${i}`;
      const popup = document.createElement("div");
      popup.className = "popup-card";
      popup.innerHTML = `
        <strong>${escapeHTML(item.address)}</strong>
        <label for="status-${markerId}">Voter Intention</label>
        <select id="status-${markerId}">
          <option value="" disabled ${!item.status ? "selected" : ""}>Select status...</option>
          ${["Reform","Tory","Labour","Green","Lib Dem","Undecided","Considering","Against","Knocked"].map(opt =>
            `<option value="${opt}" ${opt === item.status ? "selected" : ""}>${opt}</option>`
          ).join("")}
        </select>
        <label for="notes-${markerId}">Notes</label>
        <textarea id="notes-${markerId}" rows="3">${escapeHTML(item.notes)}</textarea>
        <label>Ward: ${escapeHTML(item.sheetName)}</label>
        <button id="saveBtn-${markerId}">Save</button>
      `;

      const infoWindow = new google.maps.InfoWindow({ content: popup });

      marker.addListener("click", () => {
        infoWindow.open(map, marker);
        google.maps.event.addListenerOnce(infoWindow, "domready", () => {
          const saveBtn = document.getElementById(`saveBtn-${markerId}`);
          const statusField = document.getElementById(`status-${markerId}`);
          const notesField = document.getElementById(`notes-${markerId}`);

          saveBtn.onclick = async () => {
            const newStatus = statusField.value;
            const newNotes = notesField.value;
            const latLong = `${item.lat},${item.lng}`;
            const sheetName = item.sheetName;

            await fetch(API, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({
                action: "updateStatus",
                latLong,
                newStatus,
                newNotes,
                user: userInfo.user,
                sheetName
              })
            });

            const updatedColor = intentionColors[newStatus] || "#cccccc";
            marker.setIcon({
              path: google.maps.SymbolPath.CIRCLE,
              fillColor: updatedColor,
              fillOpacity: 1,
              strokeColor: "white",
              strokeWeight: 1,
              scale: 6
            });

            infoWindow.close();
            showModal();
          };
        });
      });
    });
  });

  if (!bounds.isEmpty()) {
    try { map.fitBounds(bounds); } catch (e) {}
  }

  const center = wardCenters[selectedSheet] || defaultCenter;
  map.setCenter(center);
  map.setZoom(14.5);

  if (window._markerCluster) {
    window._markerCluster.clearMarkers();
}

window._markerCluster = new markerClusterer.MarkerClusterer({
    map,
    markers: window._markersArray,

    onClusterClick: (cluster) => {
      const markers = cluster.markers;

      const counts = {};
      markers.forEach(m => {
        const s = m.status || "Undecided";
        counts[s] = (counts[s] || 0) + 1;
      });

      let breakdown = "<strong>Cluster Breakdown</strong><br>";
      for (const s in counts) {
        breakdown += `${s}: ${counts[s]}<br>`;
      }

      const info = new google.maps.InfoWindow({
        content: breakdown,
        position: cluster.position
      });

      info.open(map);
      return false;
    },

    renderer: {
      render: ({ count, markers, position }) => {
        const statusCounts = {};
        markers.forEach(m => {
          const s = m.status || "Undecided";
          statusCounts[s] = (statusCounts[s] || 0) + 1;
        });

        const intentionColors = {
          "Labour": "#e4003b",
          "Tory": "#0087dc",
          "Lib Dem": "#faa61a",
          "Green": "#6ab023",
          "Reform": "#00b3b3",
          "Undecided": "#cccccc",
          "Considering": "#999999",
          "Against": "#000000",
          "Knocked": "#9966cc"
        };

        const total = markers.length;
        let startAngle = 0;
        const slices = [];

        for (const status in statusCounts) {
          const value = statusCounts[status];
          const angle = (value / total) * Math.PI * 2;
          const endAngle = startAngle + angle;

          const x1 = 50 + 50 * Math.cos(startAngle);
          const y1 = 50 + 50 * Math.sin(startAngle);
          const x2 = 50 + 50 * Math.cos(endAngle);
          const y2 = 50 + 50 * Math.sin(endAngle);

          const largeArc = angle > Math.PI ? 1 : 0;

          const path = `
            M 50 50
            L ${x1} ${y1}
            A 50 50 0 ${largeArc} 1 ${x2} ${y2}
            Z
          `;

          slices.push(`
            <path d="${path}"
                  fill="${intentionColors[status] || "#cccccc"}"
                  stroke="white"
                  stroke-width="1"/>
          `);

          startAngle = endAngle;
        }

        const svg = `
          <svg width="60" height="60" viewBox="0 0 100 100">
            ${slices.join("")}
            <circle cx="50" cy="50" r="30" fill="white"/>
            <text x="50" y="57"
                  text-anchor="middle"
                  font-size="28"
                  font-weight="bold"
                  fill="#333">
              ${count}
            </text>
          </svg>
        `;

        const svgUrl = "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg);

        return new google.maps.Marker({
          position,
          icon: {
            url: svgUrl,
            scaledSize: new google.maps.Size(60, 60)
          }
        });
      }
    }
});
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("sheetFilter").addEventListener("change", fetchAndRenderMarkers);

  document.getElementById("filterBtn").addEventListener("click", () => {
    const selector = document.getElementById("wardSelector");
    selector.style.display = selector.style.display === "none" ? "block" : "none";
  });

  document.getElementById("locateBtn").addEventListener("click", () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((position) => {
        const userLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };

        new google.maps.Marker({
          position: userLocation,
          map,
          title: "You are here",
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: "#4285F4",
            fillOpacity: 1,
            strokeColor: "white",
            strokeWeight: 2,
            scale: 8
          }
        });

        new google.maps.Circle({
          strokeColor: "#4285F4",
          strokeOpacity: 0.8,
          strokeWeight: 1,
          fillColor: "#4285F4",
          fillOpacity: 0.2,
          map,
          center: userLocation,
          radius: position.coords.accuracy || 50
        });

        map.setCenter(userLocation);
      }, () => {
        showStatus("Location access denied or unavailable.");
      });
    } else {
      showStatus("Geolocation not supported.");
    }
  });

  document.getElementById("logoutToolbarBtn").addEventListener("click", () => {
    window.location.href = "login.html";
  });
});

function showModal() {
  const modal = document.getElementById("saveModal");
  modal.style.display = "flex";
  setTimeout(() => {
    modal.style.display = "none";
  }, 1000);
}
</script>
  </head>

  <body>
    <div id="statusMessage"></div>
    <div id="userInfo"></div>
    <div id="map"></div>

    <div id="legend">
      <strong>Legend</strong><br>
      <span style="color:#e4003b">‚óè Labour</span><br>
      <span style="color:#0087dc">‚óè Tory</span><br>
      <span style="color:#faa61a">‚óè Lib Dem</span><br>
      <span style="color:#6ab023">‚óè Green</span><br>
      <span style="color:#00b3b3">‚óè Reform</span><br>
      <span style="color:#cccccc">‚óè Undecided</span><br>
      <span style="color:#999999">‚óè Considering</span><br>
      <span style="color:#000000">‚óè Against</span><br>
      <span style="color:#9966cc">‚óè Knocked</span>
    </div>

    <div id="wardSelector">
      <label for="sheetFilter"><strong>Filter by Ward</strong></label><br>
      <select id="sheetFilter">
                <option value="" selected disabled>Select a ward‚Ä¶</option>
        <option value="All">All Wards</option>
      </select>
    </div>

    <div id="saveModal">
      <div class="modal-content">
        <img src="https://upload.wikimedia.org/wikipedia/en/0/06/Logo_of_the_Reform_UK.svg" alt="Reform UK Logo">
        <h3>Intelligence Logged</h3>
      </div>
    </div>

    <div id="mobileToolbar">
      <button id="filterBtn">Filter Ward</button>
      <button id="locateBtn">üìç Locate Me</button>
      <button id="logoutToolbarBtn">Logout</button>
    </div>

    <!-- ‚úÖ Google Maps Loader -->
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB0hVyEg_1Rbi7IoqflyOslsv81KE3VSsY&callback=init&libraries=places">
    </script>

  </body>
</html>
