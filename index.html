<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Campaign Map</title>
    <link rel="manifest" href="https://londoncampaignsgroupreform-bit.github.io/manifest.json">
    <meta name="theme-color" content="#00b3b3">
    <link rel="icon" type="image/jpeg" href="ReformUKlondon.jpg">
    <style>
      /* [Your existing CSS remains unchanged] */
      /* ... */
    </style>
  </head>
  <body>
    <button id="logoutBtn" onclick="logout()">Logout</button>
    <div id="userInfo">
      Logged in as <strong id="userDisplay"></strong><br>
      Role: <strong id="roleDisplay"></strong><br>
      Access: <span id="accessDisplay"></span>
    </div>
    <button id="locateMeBtn">üìç Locate Me</button>
    <div id="map"></div>
    <div id="legend">
      <strong>Legend</strong><br>
      <span style="color:#e4003b">‚óè Labour</span><br>
      <span style="color:#0087dc">‚óè Tory</span><br>
      <span style="color:#faa61a">‚óè Lib Dem</span><br>
      <span style="color:#6ab023">‚óè Green</span><br>
      <span style="color:#00b3b3">‚óè Reform</span><br>
      <span style="color:#cccccc">‚óè Undecided</span><br>
      <span style="color:#999999">‚óè Considering</span><br>
      <span style="color:#000000">‚óè Against</span><br>
      <span style="color:#9966cc">‚óè Knocked</span>
    </div>
    <div id="wardSelector">
      <label for="sheetFilter"><strong>Filter by Ward</strong></label><br>
      <select id="sheetFilter">
        <option value="" selected disabled>Select a ward‚Ä¶</option>
        <option value="All">All Wards</option>
      </select>
    </div>
    <div id="saveModal">
      <div class="modal-content">
        <img src="https://upload.wikimedia.org/wikipedia/en/0/06/Logo_of_the_Reform_UK.svg" alt="Reform UK Logo">
        <h3>Intelligence Logged</h3>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const user = params.get("user");
      const role = params.get("role");
      const sheetNames = (params.get("sheets") || "").split(",");

      if (user) sessionStorage.setItem("user", user);
      if (role) sessionStorage.setItem("role", role);
      if (sheetNames.length) sessionStorage.setItem("sheetNames", JSON.stringify(sheetNames));
      sessionStorage.setItem("loggedIn", "true");

      if (sessionStorage.getItem("loggedIn") !== "true") {
        window.location.href = "login.html";
      }

      function escapeHTML(str) {
        if (typeof str !== "string") str = String(str || "");
        return str.replace(/[&<>'"]/g, c => ({
          "&": "&amp;", "<": "&lt;", ">": "&gt;", "'": "&#39;", '"': "&quot;"
        }[c]));
      }

      function logout() {
        fetch("https://script.google.com/macros/s/AKfycby44MhPl0LFSvPOtCpgRzHWNN3nIyAs0n_dFO7qdsPH7XqFBy2XiR4oGdRRfhQ1TX8T/exec?action=logout")
          .then(() => {
            sessionStorage.clear();
            window.location.href = "login.html";
          })
          .catch(err => console.error("‚ùå Logout failed", err));
      }

      function showModal() {
        const modal = document.getElementById("saveModal");
        modal.style.display = "flex";
        setTimeout(() => { modal.style.display = "none"; }, 1000);
      }

      window.onload = () => {
        document.getElementById("userDisplay").textContent = sessionStorage.getItem("user") || "Unknown";
        document.getElementById("roleDisplay").textContent = sessionStorage.getItem("role") || "Unknown";
        document.getElementById("accessDisplay").textContent = JSON.parse(sessionStorage.getItem("sheetNames") || "[]").join(", ");

        const sheetList = JSON.parse(sessionStorage.getItem("sheetNames") || "[]");
        const filter = document.getElementById("sheetFilter");
        sheetList.forEach(name => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          filter.appendChild(option);
        });
      };

      document.getElementById("sheetFilter").addEventListener("change", () => {
        initMap();
      });

      document.getElementById("locateMeBtn").addEventListener("click", () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition((position) => {
            const userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            new google.maps.Marker({
              position: userLocation,
              map: map,
              title: "You are here",
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: "#4285F4",
                fillOpacity: 1,
                strokeColor: "white",
                strokeWeight: 2,
                scale: 8
              }
            });

            new google.maps.Circle({
              strokeColor: "#4285F4",
              strokeOpacity: 0.8,
              strokeWeight: 1,
              fillColor: "#4285F4",
              fillOpacity: 0.2,
              map: map,
              center: userLocation,
              radius: position.coords.accuracy || 50
            });

            map.setCenter(userLocation);
          }, () => {
            alert("Location access denied or unavailable.");
          });
        } else {
          alert("Geolocation is not supported by your browser.");
        }
      });

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/service-worker.js")
          .then(() => console.log("‚úÖ Service Worker registered"))
          .catch(err => console.error("‚ùå Service Worker failed", err));
      }

      let map;
      const wardCenters = {
        "Bedfont": { lat: 51.4485, lng: -0.4325 },
        "Feltham North": { lat: 51.4560, lng: -0.4080 },
        "Feltham West": { lat: 51.4470, lng: -0.4170 },
        "Hanworth Park": { lat: 51.4375, lng: -0.3860 },
        "Hanworth Village": { lat: 51.4290, lng: -0.3790 }
      };
      const defaultCenter = { lat: 51.4405, lng: -0.4085 };

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: defaultCenter,
          zoom: 14.5
        });

        fetch("https://script.google.com/macros/s/AKfycby44MhPl0LFSvPOtCpgRzHWNN3nIyAs0n_dFO7qdsPH7XqFBy2XiR4oGdRRfhQ1TX8T/exec?path=map-data")
          .then(res => res.json())
          .then(renderMarkers)
          .catch(err => console.error("‚ùå Failed to load map data", err));
      }

      function renderMarkers(data) {
        const selectedSheet = document.getElementById("sheetFilter").value;
        if (!selectedSheet) return;

        const grouped = {};
        const bounds = new google.maps.LatLngBounds();

        data.forEach((row) => {
          let [lat, lng, address, status, notes, sheetName] = row;
          const latNum = parseFloat(lat);
          const lngNum = parseFloat(lng);
          if (isNaN(latNum) || isNaN(lngNum)) return;

          address = String(address || "");
          status = String(status || "");
          notes = String(notes || "");
          sheetName = String(sheetName || "");

          if (selectedSheet !== "All" && sheetName !== selectedSheet) return;

          const key = `${latNum.toFixed(4)},${lngNum.toFixed(4)}`;
          if (!grouped[key]) grouped[key] = [];
          grouped[key].push({ lat: latNum, lng: lngNum, address, status, notes,

          sheetName });
        });

        Object.values(grouped).forEach((group) => {
          const count = group.length;
          const angleStep = (2 * Math.PI) / count;
          const radius = 0.0001;

          group.forEach((item, i) => {
            const angle = i * angleStep;
            const offsetLat = item.lat + radius * Math.cos(angle);
            const offsetLng = item.lng + radius * Math.sin(angle);

            const intentionColors = {
              "Labour": "#e4003b",
              "Tory": "#0087dc",
              "Lib Dem": "#faa61a",
              "Green": "#6ab023",
              "Reform": "#00b3b3",
              "Undecided": "#cccccc",
              "Considering": "#999999",
              "Against": "#000000",
              "Knocked": "#9966cc"
            };
            const color = intentionColors[item.status] || "#cccccc";

            const marker = new google.maps.Marker({
              map,
              position: { lat: offsetLat, lng: offsetLng },
              title: `${item.status}: ${item.address}`,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: color,
                fillOpacity: 1,
                strokeColor: "white",
                strokeWeight: 1,
                scale: 6
              }
            });
            bounds.extend(marker.getPosition());

            const markerId = `marker-${item.lat}-${item.lng}-${i}`;
            const popup = document.createElement("div");
            popup.className = "popup-card";
            popup.innerHTML = `
              <strong>${escapeHTML(item.address)}</strong>
              <label for="status-${markerId}">Voter Intention</label>
              <select id="status-${markerId}">
                <option value="" disabled ${!item.status ? "selected" : ""}>Select status...</option>
                ${["Reform","Tory","Labour","Green","Lib Dem","Undecided","Considering","Against","Knocked"].map(opt =>
                  `<option value="${opt}" ${opt === item.status ? "selected" : ""}>${opt}</option>`
                ).join("")}
              </select>
              <label for="notes-${markerId}">Notes</label>
              <textarea id="notes-${markerId}" rows="3">${escapeHTML(item.notes)}</textarea>
              <label>Ward: ${escapeHTML(item.sheetName)}</label>
              <button id="saveBtn-${markerId}">Save</button>
            `;

            const infoWindow = new google.maps.InfoWindow({ content: popup });

            marker.addListener("click", () => {
              infoWindow.open(map, marker);
              google.maps.event.addListenerOnce(infoWindow, "domready", () => {
                const saveBtn = document.getElementById(`saveBtn-${markerId}`);
                const statusField = document.getElementById(`status-${markerId}`);
                const notesField = document.getElementById(`notes-${markerId}`);

                saveBtn.onclick = () => {
                  const newStatus = statusField.value;
                  const newNotes = notesField.value;
                  const latLong = `${item.lat},${item.lng}`;
                  const sheetName = item.sheetName;

                  fetch("https://script.google.com/macros/s/AKfycby44MhPl0LFSvPOtCpgRzHWNN3nIyAs0n_dFO7qdsPH7XqFBy2XiR4oGdRRfhQ1TX8T/exec", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({
                      action: "updateStatus",
                      latLong,
                      newStatus,
                      newNotes,
                      user: sessionStorage.getItem("user"),
                      sheetName
                    })
                  })
                  .then(() => {
                    const updatedColor = intentionColors[newStatus] || "#cccccc";
                    marker.setIcon({
                      path: google.maps.SymbolPath.CIRCLE,
                      fillColor: updatedColor,
                      fillOpacity: 1,
                      strokeColor: "white",
                      strokeWeight: 1,
                      scale: 6
                    });
                    infoWindow.close();
                    showModal();
                  })
                  .catch(err => console.error("‚ùå Failed to update status", err));
                };
              });
            });
          });
        });

        const center = wardCenters[selectedSheet] || defaultCenter;
        map.setCenter(center);
        map.setZoom(14.5);
      }
    </script>

    <!-- Google Maps API (loads initMap automatically) -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB0hVyEg_1Rbi7IoqflyOslsv81KE3VSsY&callback=initMap&libraries=places"></script>
  </body>
</html>









